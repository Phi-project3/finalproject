{% extends "base.html" %}

{% block title %}
  Barcode Scan
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='barcode_scan_style.css') }}">
{% endblock %}

{% block content %}
<div class="center">
  <h1>Scan Barcode</h1>
  <div id="reader"></div>
  <p id="result"></p>
</div>
{% endblock %}

{% block extra_js %}
  <!-- Include the html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script>
    // Callback function for a successful scan.
    function onScanSuccess(decodedText, decodedResult) {
      console.log("Scan successful:", decodedText);
      document.getElementById("result").innerText = "Scanned: " + decodedText;
      window.location.href = "/product/" + encodeURIComponent(decodedText);
    }

    // Callback function for scan failure.
    function onScanFailure(errorMessage) {
      // Optionally log or show the error; this callback is called frequently in normal operation.
      console.warn("Scan failure: " + errorMessage);
    }

    // Initialize the scanner on the element with id "reader".
    const html5QrCode = new Html5Qrcode("reader");
    // Configuration: 10 frames per second and a 250px square scan area.
    const config = { fps: 10, qrbox: 250 };

    // Get available cameras and start the scanning process.
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        const cameraId = devices[0].id;
        // Pass both success and failure callbacks.
        html5QrCode.start(cameraId, config, onScanSuccess, onScanFailure);
      } else {
        console.error("No cameras found.");
      }
    }).catch(err => {
      console.error("Camera error:", err);
    });
  </script>
{% endblock %}
